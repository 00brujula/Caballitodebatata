<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Caballito de Batata Player</title>
<style>
body{
  background:#111;
  font-family:Tahoma, sans-serif;
  display:flex;
  justify-content:center;
  padding:30px;
}

.player{
  width:340px;
  background:linear-gradient(#2a2a2a,#000);
  border:2px solid #777;
  box-shadow:0 0 20px #000;
  color:#0f0;
}

.header{
  background:#000;
  padding:6px;
  font-size:12px;
  color:#0f0;
  text-align:center;
}

canvas{
  width:100%;
  height:100px;
  background:#000;
}

.controls{
  display:flex;
  justify-content:space-around;
  padding:6px;
}

button{
  background:#333;
  border:1px solid #888;
  color:#0f0;
  padding:4px 8px;
  cursor:pointer;
}

button:hover{
  background:#555;
}

ul{
  list-style:none;
  margin:0;
  padding:6px;
  background:#111;
  max-height:180px;
  overflow:auto;
}

li{
  padding:4px;
  cursor:pointer;
  font-size:13px;
}

li:hover{
  background:#222;
}

.active{
  background:#003300;
}

a.download{
  color:#0f0;
  font-size:12px;
  display:block;
  text-align:center;
  padding:4px;
}
</style>
</head>

<body>

<div class="player">
  <div class="header">Caballito de Batata</div>

  <canvas id="visualizer"></canvas>

  <audio id="audio"></audio>

  <div class="controls">
    <button onclick="prev()">⏮</button>
    <button onclick="toggle()">▶</button>
    <button onclick="next()">⏭</button>
  </div>

  <a id="download" class="download" target="_blank">Descargar episodio</a>

  <ul id="playlist"></ul>
</div>

<script>
let tracks=[];
let current=0;
const audio=document.getElementById("audio");
const playlist=document.getElementById("playlist");
const download=document.getElementById("download");

fetch("tracks.json")
.then(res=>res.json())
.then(data=>{
  tracks=data;
  renderPlaylist();
  load(0);
});

function renderPlaylist(){
  playlist.innerHTML="";
  tracks.forEach((t,i)=>{
    const li=document.createElement("li");
    li.textContent=t.title;
    li.onclick=()=>{load(i);audio.play();}
    playlist.appendChild(li);
  });
}

function load(i){
  current=i;
  audio.src=tracks[i].url;
  download.href=tracks[i].url;
  download.download=tracks[i].title+".mp3";
  highlight();
}

function highlight(){
  document.querySelectorAll("li").forEach((li,i)=>{
    li.classList.toggle("active",i===current);
  });
}

function toggle(){
  if(audio.paused){audio.play();}
  else{audio.pause();}
}

function next(){
  current=(current+1)%tracks.length;
  load(current);
  audio.play();
}

function prev(){
  current=(current-1+tracks.length)%tracks.length;
  load(current);
  audio.play();
}

/* Visualizer */
let audioCtx, analyser, dataArray;

audio.addEventListener("play",()=>{
  if(!audioCtx){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    analyser=audioCtx.createAnalyser();
    const src=audioCtx.createMediaElementSource(audio);
    src.connect(analyser);
    analyser.connect(audioCtx.destination);
    analyser.fftSize=128;
    dataArray=new Uint8Array(analyser.frequencyBinCount);
    draw();
  }
});

const canvas=document.getElementById("visualizer");
const ctx=canvas.getContext("2d");
canvas.width=340;
canvas.height=100;

function draw(){
  requestAnimationFrame(draw);
  analyser.getByteFrequencyData(dataArray);
  ctx.fillStyle="#000";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  const barWidth=(canvas.width/dataArray.length)*2;
  let x=0;
  for(let i=0;i<dataArray.length;i++){
    const h=dataArray[i]/2;
    ctx.fillStyle="rgb(0,"+(150+h)+",0)";
    ctx.fillRect(x,canvas.height-h,barWidth,h);
    x+=barWidth+1;
  }
}
</script>

</body>
</html>
